<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RG Golf Pairing (Star Demo)</title>
    <style>
        :root {
            --primary: #1e4d2b;       /* Golf Green */
            --primary-light: #e8f5e9;
            --accent: #fbc02d;        /* Gold */
            --bg: #f5f7fa;
            --white: #ffffff;
            --text: #2c3e50;
            --gray: #90a4ae;
            --border: #cfd8dc;
            --male: #1565c0;
            --female: #c2185b;
            --error: #e53935;
            --radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        }

        .container { max-width: 650px; margin: 0 auto; padding: 15px; width: 100%; box-sizing: border-box; flex: 1; }
        
        header {
            background: var(--white); padding: 12px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;
        }
        header h1 { margin: 0; font-size: 18px; color: var(--primary); font-weight: 800; }
        .badge { background: var(--primary-light); color: var(--primary); font-size: 10px; padding: 3px 6px; border-radius: 4px; }

        .stepper { display: flex; margin-bottom: 15px; background: var(--white); border-radius: 30px; padding: 4px; border: 1px solid var(--border); }
        .step { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; color: var(--gray); cursor: pointer; border-radius: 20px; transition: 0.2s; }
        .step.active { background: var(--primary); color: white; }

        .card { background: var(--white); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        h2 { margin: 0 0 10px 0; font-size: 16px; color: var(--primary); border-left: 4px solid var(--accent); padding-left: 8px; }

        textarea { width: 100%; height: 250px; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); resize: none; box-sizing: border-box; font-size: 14px; font-family: inherit; line-height: 1.4; }
        textarea:focus { outline: none; border-color: var(--primary); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: var(--radius); font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: #43a047; color: white; }

        /* Info Form */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .info-item label { font-size: 11px; font-weight: bold; color: var(--gray); display: block; margin-bottom: 4px; }
        .info-item input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .info-full { grid-column: span 2; }

        /* Player Row */
        .player-list { display: flex; flex-direction: column; gap: 6px; }
        .player-row {
            display: flex; align-items: center; gap: 8px;
            background: white; border: 1px solid var(--border);
            padding: 6px 10px; border-radius: 6px;
        }
        .player-row.locked { background-color: #fff8e1; border-color: var(--accent); }

        .gender-toggle {
            width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer; flex-shrink: 0; border: 1px solid #eee;
        }
        .gender-toggle.male { background: #e3f2fd; color: var(--male); border-color: #bbdefb; }
        .gender-toggle.female { background: #fce4ec; color: var(--female); border-color: #f8bbd0; }

        .name-edit { flex: 1; border: none; background: transparent; font-size: 15px; min-width: 50px; padding: 4px; }
        .name-edit:focus { outline: none; border-bottom: 2px solid var(--accent); }
        .hcp-edit { width: 35px; text-align: center; border: 1px solid var(--border); border-radius: 4px; padding: 4px; font-size: 13px; }
        .group-select { width: 60px; padding: 4px; border: 1px solid var(--border); border-radius: 4px; font-size: 12px; background: #f9f9f9; cursor: pointer; }
        .group-select.active { background: var(--accent); color: #000; font-weight: bold; }
        .del-btn { background: none; border: none; color: #ef5350; font-size: 18px; cursor: pointer; padding: 0 4px; }

        /* Results */
        .scorecard { background: white; border-radius: 8px; overflow: hidden; margin-bottom: 12px; border-left: 5px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .scorecard.invalid { border-left-color: var(--error); background: #ffebee; }
        
        .sc-header { padding: 8px 12px; background: #f1f8e9; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; }
        .sc-info { display: flex; align-items: center; gap: 8px; }
        .sc-title { font-weight: 800; font-size: 14px; color: var(--primary); }
        
        .order-btns { display: flex; gap: 2px; }
        .arrow-btn { 
            width: 24px; height: 24px; border: 1px solid #ccc; background: white; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; font-size: 12px;
        }

        .res-list { display: flex; flex-direction: column; }
        .res-item { display: flex; align-items: center; padding: 10px 12px; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .res-item:last-child { border-bottom: none; }
        .res-name { flex: 1; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .res-name.male { color: var(--male); }
        .res-name.female { color: var(--female); }
        .res-hcp { width: 40px; text-align: center; color: #666; font-weight: bold; margin-right: 8px; }
        .res-move { width: 85px; padding: 3px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px; background: white; }

        .event-summary { background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; line-height: 1.6; }

        footer { text-align: center; padding: 20px; color: #90a4ae; font-size: 13px; font-weight: 600; border-top: 1px solid #eee; margin-top: auto; }
        
        .hidden { display: none !important; }
        #toast { visibility: hidden; min-width: 250px; background: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 999; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.error { background: var(--error); }
    </style>
</head>
<body>

<header>
    <h1>â›³ï¸ RG PAIRING <span class="badge">V25</span></h1>
</header>

<div class="container">
    
    <div class="stepper">
        <div class="step active" id="tab-1" onclick="app.goToStep(1)">1. è¼¸å…¥</div>
        <div class="step" id="tab-2" onclick="app.goToStep(2)">2. ç·¨è¼¯</div>
        <div class="step" id="tab-3">3. çµæœ</div>
    </div>

    <!-- VIEW 1 -->
    <div id="view-1">
        <div class="card">
            <h2>ğŸ“ åå–®è¼¸å…¥</h2>
            <div style="font-size:13px; color:#666; margin-bottom:10px; background:#f1f8e9; padding:8px; border-radius:6px;">
                ğŸ’¡ æ”¯æ´ç·¨è™Ÿæ¸…å–®ï¼ˆå¦‚ï¼š1. Jasonï¼‰ï¼Œè‹¥ç„¡ HCP å°‡é è¨­ç‚º 0ã€‚<br>
                ğŸ’¡ è‡ªå‹•è¾¨è­˜æ—¥æœŸã€åœ°é»èˆ‡è²»ç”¨ã€‚
            </div>
            <textarea id="input-text" placeholder="è²¼ä¸Šæ‚¨çš„ Line/WhatsApp çƒéšŠå ±ååå–®..."></textarea>
            <button class="btn btn-primary" onclick="app.processInput()">è§£æåå–® â”</button>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-outline" onclick="app.loadDemo()">è¼‰å…¥æ¸¬è©¦åå–® (æ˜æ˜Ÿç‰ˆ)</button>
                <button class="btn btn-outline" onclick="app.clearInput()" style="color:#e53935;">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- VIEW 2 -->
    <div id="view-2" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>âš™ï¸ ç·¨è¼¯è³‡è¨Š</h2>
                <span id="count-info" style="font-size:12px; font-weight:bold; color:var(--primary);">0 äºº</span>
            </div>

            <!-- Event Info Form -->
            <div class="info-grid">
                <div class="info-item">
                    <label>æ—¥æœŸ</label>
                    <input id="info-date" placeholder="YYYY/MM/DD">
                </div>
                <div class="info-item">
                    <label>æ™‚é–“</label>
                    <input id="info-time" placeholder="HH:MM">
                </div>
                <div class="info-item">
                    <label>è²»ç”¨</label>
                    <input id="info-price" placeholder="ä¾‹ï¼š3700">
                </div>
                <div class="info-item">
                    <label>çƒå ´</label>
                    <input id="info-course" placeholder="ä¾‹ï¼šé•·åºšçƒå ´">
                </div>
            </div>

            <!-- Add Player -->
            <div style="display:flex; gap:8px; margin-bottom:10px; padding:8px; background:#e3f2fd; border-radius:6px;">
                <input id="new-name" class="name-edit" style="background:white; border-radius:4px;" placeholder="æ–°å¢å§“å">
                <input id="new-hcp" type="number" class="hcp-edit" style="background:white;" placeholder="HCP">
                <button class="btn-primary" style="width:auto; padding:0 12px; margin:0;" onclick="app.addPlayer()">+</button>
            </div>

            <div id="player-list" class="player-list" style="max-height: 400px; overflow-y: auto;"></div>

            <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div>
                    <label style="font-size:11px; font-weight:bold; color:#888;">ç­–ç•¥</label>
                    <select id="hcp-mode" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; margin-top:4px;">
                        <option value="snake">âš–ï¸ Så‹æ’åº</option>
                        <option value="competitive">âš”ï¸ å¯¦åŠ›åˆ†å±¤</option>
                        <option value="random">ğŸ² éš¨æ©Ÿ</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:11px; font-weight:bold; color:#888;">æ€§åˆ¥</label>
                    <select id="gender-mode" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; margin-top:4px;">
                        <option value="mixed">ğŸ‘« å¹³å‡æ··ç·¨</option>
                        <option value="separate">ç”·å¥³åˆ†é–‹</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" onclick="app.tryGenerate()">é–‹å§‹åˆ†çµ„ â›³</button>
        </div>
    </div>

    <!-- VIEW 3 -->
    <div id="view-3" class="hidden">
        <div id="event-header-display"></div>
        <div id="result-container"></div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-outline" onclick="app.goToStep(1)">â†º é‡ä¾†</button>
            <button class="btn btn-success" onclick="app.copyList()">ğŸ“‹ è¤‡è£½åå–®</button>
        </div>
        <div style="height:20px;"></div>
    </div>

</div>

<footer>
    å‹ç”·æ­£å¦¹é«˜çˆ¾å¤«çƒéšŠ
</footer>

<div id="toast"></div>

<script>
const app = {
    data: { players: [], groups: [], idCount: 1 },

    goToStep: (n) => {
        document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
        document.getElementById(`tab-${n}`).classList.add('active');
        ['view-1','view-2','view-3'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById(`view-${n}`).classList.remove('hidden');
        window.scrollTo(0,0);
    },

    showToast: (msg, isError=false) => {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.className = isError ? "show error" : "show";
        setTimeout(() => t.className = "", 3000);
    },

    loadDemo: () => {
        document.getElementById('input-text').value = 
`âš ï¸å¥½èŠå¡¢èˆ‡è¯èªå·¨æ˜Ÿè¯èª¼è³½âš ï¸
åŠ›é‚€å„ä½å·¨æ˜Ÿ
åœ°é»ï¼šé•·åºšçƒå ´
æ—¥æœŸï¼š12/25
æ™‚é–“ï¼š10:30
åƒ¹æ ¼ï¼š3700
çµ„æ•¸ï¼š5
å¥³ç”Ÿè«‹è¨»è¨˜â¤ï¸
å¦‚é ˆç”¨é¤1000/ä½ï¼Œä¸¦è¨»è¨˜ğŸ±

1. Jay å‘¨æ°å€«
2. Jolin è”¡ä¾æ— ğŸ’ƒ
3. Tom Cruise
4. Scarlett Johansson â¤ï¸
5. Stephen Curry
6. LeBron James
7. æ—å¿—ç² ğŸ‘‘
8. é‡‘åŸæ­¦
9. Hebe ç”°é¦¥ç”„ ğŸ¤
10. Elon Musk
11. Taylor Swift ğŸŒ¹
12. ä¼ä½°
13. Lisa Blackpink â¤ï¸
14. Robert Downey Jr.
15. äº”æœˆå¤© é˜¿ä¿¡
16. Emma Watson ğŸ“š
17. éƒ­å°éŠ˜
18. å¼µå¿ è¬€
19. æ¢æœå‰
20. èˆ’æ·‡ â¤ï¸
è³€æ»¿çµ„ğŸŠğŸŠğŸŠğŸŠ`;
    },
    clearInput: () => {
        document.getElementById('input-text').value = '';
        document.getElementById('info-date').value = '';
        document.getElementById('info-time').value = '';
        document.getElementById('info-course').value = '';
        document.getElementById('info-price').value = '';
    },

    processInput: () => {
        const raw = document.getElementById('input-text').value;
        if(!raw.trim()) { app.showToast("è«‹è¼¸å…¥å…§å®¹", true); return; }
        
        app.data.players = [];
        app.data.idCount = 1;
        
        const femaleRegex = /Ms|Mrs|Miss|Lady|å¥³|å§|å¦¹|å«‚|åª½|å©†|â™€ï¸|â™€|ğŸšº|ğŸ‘©|ğŸ‘§|ğŸ‘¸|ğŸ‘‘|ğŸŒ¹|ğŸŒ¸|ğŸŒº|â¤ï¸|â™¥ï¸|ğŸ©·|ğŸ’ƒ|ğŸ’„|ğŸ‘ /i;
        const dateRegex = /(\d{4}[-/.]\d{1,2}[-/.]\d{1,2})|(\d{1,2}[-/.]\d{1,2})|(\d{1,2}æœˆ\d{1,2}æ—¥)/;
        const timeRegex = /(\d{1,2}:\d{2})|(\d{1,2}é»)/;
        const courseRegex = /(çƒå ´|Golf|Club|C\.C|CC)/i;
        const priceRegex = /(åƒ¹æ ¼|è²»ç”¨)/i;
        const chineseRegex = /[\u4e00-\u9fa5]+/g;
        const noiseRegex = /(è¨»è¨˜|æ³¨è¨˜|ç”¨é¤|æ»¿çµ„|æˆªæ­¢|å ±å|çµ±è¨ˆ|ç¾¤çµ„|ç¹³è²»|æ¯äºº|çƒéšŠ|é‚€è«‹|CEO|å•†å‘¨|çµ„æ•¸)/i;

        let foundDate = "", foundTime = "", foundCourse = "", foundPrice = "";

        const lines = raw.split('\n');
        
        lines.forEach((line) => {
            let clean = line.trim();
            if(!clean || clean.match(/^[-=_*]{3,}$/)) return; 

            // 1. Info Detection
            let isMeta = false;
            
            if (clean.includes("æ—¥æœŸ") || dateRegex.test(clean)) {
                if(!foundDate) {
                    let m = clean.match(dateRegex);
                    if(m) { foundDate = m[0]; isMeta = true; }
                }
            }
            if (clean.includes("æ™‚é–“") || timeRegex.test(clean)) {
                if(!foundTime) {
                    let m = clean.match(timeRegex);
                    if(m) { foundTime = m[0]; isMeta = true; }
                }
            }
            if (clean.includes("åœ°é»") || courseRegex.test(clean)) {
                if(!foundCourse) {
                    foundCourse = clean.replace(/åœ°é»|:|ï¼š/g, '').trim();
                    isMeta = true;
                }
            }
            if ((clean.includes("åƒ¹æ ¼") || clean.includes("è²»ç”¨") || clean.includes("Price")) && /\d+/.test(clean)) {
                if(!foundPrice) {
                     let p = clean.replace(/åƒ¹æ ¼|è²»ç”¨|:|ï¼š/g, '').trim();
                     if (parseInt(p) > 0) {
                        foundPrice = p;
                        isMeta = true;
                     }
                }
            }

            if (isMeta) return;

            // 2. Noise Filtering
            if (noiseRegex.test(clean)) return;

            // 3. Player Detection
            let hcp = 0;
            let rawName = "";
            let isValidPlayer = false;

            // Try "1. Name"
            let listMatch = clean.match(/^(\d+)[.\s\ã€]+(.+)/);
            
            if (listMatch) {
                rawName = listMatch[2].trim();
                isValidPlayer = true;
                // Check if HCP exists at end
                let hcpMatch = rawName.match(/(\d+(\.\d+)?)$/);
                if (hcpMatch) {
                    let val = parseFloat(hcpMatch[0]);
                    if (val < 60) {
                        hcp = val;
                        rawName = rawName.substring(0, hcpMatch.index).trim();
                    }
                }
            } else {
                // Try "Name HCP"
                let tempClean = clean.replace(/^[\d\.\s]+/, ''); 
                let hcpMatch = tempClean.match(/(\d+(\.\d+)?)$/);
                if (hcpMatch) {
                    let val = parseFloat(hcpMatch[0]);
                    if (val < 60) {
                        hcp = val;
                        rawName = tempClean.substring(0, hcpMatch.index).trim();
                        isValidPlayer = true;
                    }
                }
            }

            if (isValidPlayer && rawName.length > 0) {
                const isFemale = femaleRegex.test(rawName);
                
                // Name Reordering
                let finalName = rawName;
                const chineseMatch = rawName.match(chineseRegex);
                if (chineseMatch) {
                    const chinesePart = chineseMatch.join('');
                    const otherPart = rawName.replace(chineseRegex, '').trim();
                    if (otherPart) finalName = `${chinesePart} ${otherPart}`;
                    else finalName = chinesePart;
                }

                app.data.players.push({
                    id: app.data.idCount++,
                    name: finalName,
                    hcp: hcp,
                    gender: isFemale ? 'F' : 'M',
                    lock: 0
                });
            }
        });

        if(foundDate) document.getElementById('info-date').value = foundDate;
        if(foundTime) document.getElementById('info-time').value = foundTime;
        if(foundCourse) document.getElementById('info-course').value = foundCourse;
        if(foundPrice) document.getElementById('info-price').value = foundPrice;

        app.renderList();
        app.goToStep(2);
    },

    renderList: () => {
        const div = document.getElementById('player-list');
        div.innerHTML = '';
        const N = app.data.players.length;
        const maxGroups = Math.max(1, Math.ceil(N / 4)); 
        let opts = `<option value="0">è‡ªå‹•</option>`;
        for(let i=1; i<=maxGroups; i++) opts += `<option value="${i}">G${i}</option>`;

        app.data.players.forEach(p => {
            if (p.lock > maxGroups) p.lock = 0;
            const row = document.createElement('div');
            row.className = `player-row ${p.lock > 0 ? 'locked' : ''}`;
            row.innerHTML = `
                <div class="gender-toggle ${p.gender==='M'?'male':'female'}" onclick="app.toggleGender(${p.id})">
                    ${p.gender==='M'?'â™‚':'â™€'}
                </div>
                <input class="name-edit" value="${p.name}" onchange="app.updateP(${p.id}, 'name', this.value)">
                <input type="number" class="hcp-edit" value="${p.hcp}" onchange="app.updateP(${p.id}, 'hcp', this.value)" placeholder="HCP">
                <select class="group-select ${p.lock>0?'active':''}" onchange="app.updateLock(${p.id}, this.value)">${opts}</select>
                <button class="del-btn" onclick="app.delP(${p.id})">Ã—</button>
            `;
            row.querySelector('select').value = p.lock;
            div.appendChild(row);
        });
        document.getElementById('count-info').innerText = `${N} äºº (å…± ${maxGroups} çµ„)`;
    },

    addPlayer: () => {
        const n = document.getElementById('new-name').value.trim();
        const h = document.getElementById('new-hcp').value;
        if(n) {
            app.data.players.push({ id: app.data.idCount++, name: n, hcp: parseFloat(h)||0, gender:'M', lock:0 });
            document.getElementById('new-name').value = '';
            document.getElementById('new-hcp').value = '';
            app.renderList();
        }
    },
    delP: (id) => { app.data.players = app.data.players.filter(x=>x.id!==id); app.renderList(); },
    updateP: (id, k, v) => { 
        const p = app.data.players.find(x=>x.id===id);
        if(k==='hcp') p.hcp = parseFloat(v)||0; else p.name = v.trim();
    },
    toggleGender: (id) => {
        const p = app.data.players.find(x=>x.id===id);
        p.gender = p.gender==='M'?'F':'M';
        app.renderList();
    },
    updateLock: (id, val) => {
        const p = app.data.players.find(x=>x.id===id);
        p.lock = parseInt(val);
        app.renderList(); 
    },

    tryGenerate: () => {
        const pool = [...app.data.players];
        const N = pool.length;

        if(N < 3) { app.showToast("è‡³å°‘éœ€è¦3äºº", true); return; }
        if(N === 5) { app.showToast("5äººç„¡æ³•ç¬¦åˆ3-4äººä¸€çµ„è¦å‰‡", true); return; }

        const numGroups = Math.ceil(N / 4);
        const groupCaps = new Array(numGroups).fill(3);
        const remainder = N - (numGroups * 3);
        for(let i=0; i<remainder; i++) groupCaps[i] = 4;

        const locks = pool.filter(p => p.lock > 0);
        if (locks.some(p => p.lock > numGroups)) {
            app.showToast(`åªèƒ½åˆ† ${numGroups} çµ„ï¼Œè«‹ä¿®æ­£æŒ‡å®šçµ„åˆ¥`, true);
            return;
        }

        const lockCounts = new Array(numGroups).fill(0);
        locks.forEach(p => lockCounts[p.lock-1]++);
        if (lockCounts.some(c => c > 4)) {
            app.showToast("å–®çµ„æŒ‡å®šäººæ•¸ä¸å¯è¶…é 4 äºº", true);
            return;
        }

        let groups = groupCaps.map(cap => ({ cap: cap, members: [] }));
        locks.forEach(p => groups[p.lock-1].members.push(p));

        let autoPlayers = pool.filter(p => p.lock === 0);
        const mode = document.getElementById('hcp-mode').value;
        const gMode = document.getElementById('gender-mode').value;
        const sortFn = (list) => {
            if(mode==='random') return list.sort(()=>Math.random()-0.5);
            if(mode==='competitive') return list.sort((a,b)=>a.hcp-b.hcp);
            return list.sort((a,b)=>b.hcp-a.hcp);
        };

        if (gMode === 'separate') {
            const f = autoPlayers.filter(p=>p.gender==='F');
            const m = autoPlayers.filter(p=>p.gender==='M');
            sortFn(f); sortFn(m);
            autoPlayers = [...f, ...m];
            
            autoPlayers.forEach((p) => {
                let placed = false;
                for(let gIdx=0; gIdx<numGroups; gIdx++) {
                    if(groups[gIdx].members.length < groups[gIdx].cap) {
                        groups[gIdx].members.push(p);
                        placed = true;
                        break;
                    }
                }
                if(!placed) groups[numGroups-1].members.push(p);
            });

        } else if (gMode === 'mixed') {
            const f = autoPlayers.filter(p=>p.gender==='F');
            const m = autoPlayers.filter(p=>p.gender==='M');
            sortFn(f); sortFn(m);

            const distribute = (list) => {
                list.forEach((p, i) => {
                    let round = Math.floor(i / numGroups);
                    let col = i % numGroups;
                    let targetIdx = (mode === 'snake' && round % 2 === 1) ? (numGroups - 1 - col) : col;
                    
                    if(groups[targetIdx].members.length < groups[targetIdx].cap) {
                        groups[targetIdx].members.push(p);
                    } else {
                        let open = groups.find(g => g.members.length < g.cap);
                        if(open) open.members.push(p);
                    }
                });
            };
            distribute(f);
            distribute(m);
        } else {
            sortFn(autoPlayers);
             autoPlayers.forEach((p) => {
                 let placed = false;
                for(let gIdx=0; gIdx<numGroups; gIdx++) {
                    if(groups[gIdx].members.length < groups[gIdx].cap) {
                        groups[gIdx].members.push(p);
                        placed = true;
                        break;
                    }
                }
                if(!placed) groups[numGroups-1].members.push(p);
             });
        }

        let isBad = false;
        groups.forEach((g) => {
            if(g.members.length < 3 || g.members.length > 4) isBad = true;
        });

        if (isBad) {
            app.showToast("æŒ‡å®šè¨­å®šå°è‡´ç„¡æ³•æ»¿è¶³ 3-4 äººä¸€çµ„", true);
            return;
        }

        app.data.groups = groups.map(g => g.members);
        app.renderResults();
        app.goToStep(3);
    },

    renderResults: () => {
        const info = {
            date: document.getElementById('info-date').value,
            time: document.getElementById('info-time').value,
            price: document.getElementById('info-price').value,
            course: document.getElementById('info-course').value
        };
        
        let headerHtml = '';
        if(info.date || info.course || info.time || info.price) {
            headerHtml = `<div class="event-summary">`;
            if(info.date) headerHtml += `ğŸ“… ${info.date} `;
            if(info.time) headerHtml += `ğŸ•’ ${info.time} <br>`;
            if(info.course) headerHtml += `â›³ ${info.course} `;
            if(info.price) headerHtml += `ğŸ’° ${info.price}`;
            headerHtml += `</div>`;
        }
        document.getElementById('event-header-display').innerHTML = headerHtml;

        const con = document.getElementById('result-container');
        con.innerHTML = '';
        const groups = app.data.groups;

        groups.forEach((list, idx) => {
            list.sort((a,b)=>a.hcp-b.hcp);
            const total = list.reduce((a,b)=>a+b.hcp,0);
            
            let opts = '';
            groups.forEach((_, i) => opts += `<option value="${i}" ${i===idx?'selected':''}>${i===idx?'æœ¬çµ„':'ç§»è‡³ G'+(i+1)}</option>`);

            const rows = list.map(p => `
                <div class="res-item">
                    <span class="res-name ${p.gender==='F'?'female':'male'}">
                       ${p.lock>0?'ğŸ”’':''} ${p.name}
                    </span>
                    <span class="res-hcp">${p.hcp}</span>
                    <select class="res-move" onchange="app.moveP(${p.id}, ${idx}, this.value)">${opts}</select>
                </div>
            `).join('');

            let upBtn = idx > 0 ? `<div class="arrow-btn" onclick="app.swapGroup(${idx}, -1)">â–²</div>` : ``;
            let downBtn = idx < groups.length - 1 ? `<div class="arrow-btn" onclick="app.swapGroup(${idx}, 1)">â–¼</div>` : ``;

            con.innerHTML += `
                <div class="scorecard">
                    <div class="sc-header">
                        <div class="sc-info">
                            <span class="sc-title">GROUP ${idx+1} (${list.length}äºº)</span>
                            <span style="font-size:12px; font-weight:bold; color:#666;">HCP: ${total}</span>
                        </div>
                        <div class="order-btns">
                            ${upBtn} ${downBtn}
                        </div>
                    </div>
                    <div class="res-list">${rows}</div>
                </div>
            `;
        });
    },

    moveP: (pid, from, to) => {
        if(from==to) return;
        const g = app.data.groups;
        if(g[to].length >= 4) { app.showToast("è©²çµ„å·²æ»¿ 4 äºº", true); app.renderResults(); return; }
        if(g[from].length <= 3) { app.showToast("æœ¬çµ„ä¸å¯å°‘æ–¼ 3 äºº", true); app.renderResults(); return; }
        const idx = g[from].findIndex(x=>x.id===pid);
        if(idx>-1) {
            g[to].push(g[from].splice(idx,1)[0]);
            app.renderResults();
        }
    },

    swapGroup: (idx, dir) => {
        const target = idx + dir;
        if(target >= 0 && target < app.data.groups.length) {
            [app.data.groups[idx], app.data.groups[target]] = [app.data.groups[target], app.data.groups[idx]];
            app.renderResults();
        }
    },

    copyList: () => {
        const info = {
            date: document.getElementById('info-date').value,
            time: document.getElementById('info-time').value,
            price: document.getElementById('info-price').value,
            course: document.getElementById('info-course').value
        };

        let t = "";
        if(info.date) t += `æ—¥æœŸï¼š${info.date}\n`;
        if(info.time) t += `æ™‚é–“ï¼š${info.time}\n`;
        if(info.course) t += `çƒå ´ï¼š${info.course}\n`;
        if(info.price) t += `è²»ç”¨ï¼š${info.price}\n`;
        if(t) t += "------------------\n";

        app.data.groups.forEach((g,i)=>{
            t+=`\n[ç¬¬ ${i+1} çµ„] åˆè¨ˆHCP:${g.reduce((a,b)=>a+b.hcp,0)}\n`;
            g.forEach(p=>t+=`- ${p.name} (${p.hcp})\n`);
        });
        
        t += "\nå‹ç”·æ­£å¦¹é«˜çˆ¾å¤«çƒéšŠ";

        navigator.clipboard.writeText(t).then(()=>app.showToast("å·²è¤‡è£½"));
    }
};
</script>
</body>
</html>