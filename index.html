<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RG Golf Pairing V15</title>
<style>
    :root {
        --primary: #1B5E20;      /* Golf Green */
        --primary-light: #E8F5E9;
        --secondary: #002D56;    /* Navy */
        --accent: #F9A825;       /* Gold/Sand */
        --bg: #F4F6F8;
        --white: #FFFFFF;
        --text: #37474F;
        --text-light: #90A4AE;
        --male-color: #0277BD;   /* Blue for Men */
        --female-color: #C2185B; /* Rose for Women */
        --radius: 12px;
        --shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg); color: var(--text);
        margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh;
        -webkit-font-smoothing: antialiased;
    }

    /* --- Header --- */
    header {
        background: var(--white);
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
    }
    header h1 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
    header .badge { font-size: 10px; background: var(--primary-light); color: var(--primary); padding: 3px 8px; border-radius: 20px; font-weight: bold; }

    .container { max-width: 600px; margin: 0 auto; padding: 15px; width: 100%; box-sizing: border-box; flex: 1; }

    /* --- Stepper --- */
    .step-indicator {
        display: flex; margin-bottom: 20px; background: var(--white);
        border-radius: 50px; padding: 5px; box-shadow: var(--shadow);
    }
    .step {
        flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600;
        color: var(--text-light); cursor: pointer; border-radius: 40px; transition: 0.3s;
    }
    .step.active { background-color: var(--primary); color: white; box-shadow: 0 2px 5px rgba(27,94,32,0.3); }

    /* --- Cards & Inputs --- */
    .card {
        background: var(--white); padding: 20px;
        border-radius: var(--radius); box-shadow: var(--shadow);
        margin-bottom: 20px; animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    h2 {
        margin: 0 0 15px 0; font-size: 16px; font-weight: 700; color: var(--secondary);
        display: flex; align-items: center; gap: 8px;
    }
    h2::before { content: ''; display: block; width: 4px; height: 16px; background: var(--accent); border-radius: 2px; }

    textarea {
        width: 100%; height: 160px; padding: 15px;
        border: 2px solid #EEE; border-radius: var(--radius); background: #FAFAFA;
        font-family: monospace; font-size: 15px; resize: none; box-sizing: border-box;
        transition: 0.2s; outline: none;
    }
    textarea:focus { border-color: var(--primary); background: #FFF; }

    /* --- Buttons --- */
    .btn {
        padding: 14px; border: none; border-radius: var(--radius);
        font-size: 15px; font-weight: 700; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        width: 100%; box-sizing: border-box; margin-top: 12px;
        transition: 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background-color: var(--primary); color: white; }
    .btn-secondary { background-color: var(--secondary); color: white; }
    .btn-outline { background: white; border: 1px solid #DDD; color: var(--text); box-shadow: none; }
    .btn-green { background: #2E7D32; color: white; }
    .btn:disabled { background-color: #E0E0E0; color: #9E9E9E; cursor: not-allowed; box-shadow: none; }

    /* --- List Item (Step 2) --- */
    .assign-list { display: flex; flex-direction: column; gap: 10px; }
    .assign-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px; background: #FFF; border: 1px solid #EEE; border-radius: 8px;
        transition: 0.2s;
    }
    .assign-item:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

    .name-edit {
        border: none; background: transparent; font-weight: 600; color: var(--text);
        font-size: 15px; width: 100%; padding: 5px 0; margin-left: 8px;
    }
    .name-edit:focus { outline: none; border-bottom: 2px solid var(--accent); }

    .hcp-input {
        width: 45px; padding: 6px; border: 1px solid #DDD; border-radius: 6px; 
        text-align: center; font-weight: bold; color: var(--secondary); font-size: 14px;
    }
    
    .gender-toggle {
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        border-radius: 50%; cursor: pointer; border: 1px solid #EEE; font-size: 14px; flex-shrink: 0;
        transition: 0.2s;
    }
    .gender-toggle.female { background: #FCE4EC; color: var(--female-color); border-color: #F8BBD0; }
    .gender-toggle.male { background: #E3F2FD; color: var(--male-color); border-color: #BBDEFB; }

    .btn-del {
        background: none; border: none; color: #E57373; font-size: 18px; 
        cursor: pointer; margin-left: 10px; padding: 5px;
    }

    /* --- Scorecard (Step 3) --- */
    .scorecard {
        background: white; border-radius: var(--radius); overflow: hidden; margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
        border-left: 6px solid var(--primary);
    }
    .scorecard.invalid { border-left-color: #E53935; background: #FFEBEE; }

    .scorecard-header {
        padding: 10px 15px; background: #FFF; display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid #F0F0F0;
    }
    .group-info { display: flex; align-items: baseline; gap: 8px; }
    .group-title { font-weight: 800; color: var(--secondary); font-size: 14px; text-transform: uppercase; }
    .group-stats { font-size: 11px; color: #888; background: #F5F5F5; padding: 2px 6px; border-radius: 4px; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    td { padding: 8px 15px; border-bottom: 1px solid #FAFAFA; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }

    .p-name { font-weight: 600; font-size: 15px; display: block; margin-bottom: 2px; }
    .p-name.male { color: var(--male-color); }
    .p-name.female { color: var(--female-color); }

    .move-select {
        padding: 2px 6px; border: 1px solid #EEE; border-radius: 4px; background: #FFF;
        color: #999; font-size: 11px; margin-top: 2px;
    }

    /* Order Arrows */
    .order-actions { display: flex; gap: 2px; }
    .arrow-btn {
        background: transparent; border: 1px solid #EEE; border-radius: 4px;
        width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; color: #78909C; transition: 0.2s;
    }
    .arrow-btn:hover { background: #ECEFF1; color: var(--secondary); }

    /* Toast Notification */
    #toast {
        visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
        text-align: center; border-radius: 8px; padding: 12px; position: fixed;
        z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; }

    .hidden { display: none !important; }
    .info-text { font-size: 12px; color: #78909C; line-height: 1.5; margin-bottom: 10px; }
</style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:8px;">
        <h1>RG PAIRING</h1>
        <span class="badge">V15</span>
    </div>
</header>

<div class="container">
    
    <div class="step-indicator">
        <div class="step active" id="tab-1" onclick="goToStep(1)">1. Ëº∏ÂÖ•</div>
        <div class="step" id="tab-2" onclick="goToStep(2)">2. Á∑®ËºØ</div>
        <div class="step" id="tab-3">3. ÁµêÊûú</div>
    </div>

    <!-- STEP 1: Input -->
    <div id="view-1">
        <div class="card">
            <h2>ÂêçÂñÆËº∏ÂÖ•</h2>
            <div class="info-text">
                ‚Ä¢ Á≥ªÁµ±Â∞áËá™ÂãïÊää„Äå‰∏≠ÊñáÂßìÂêç„ÄçÊéíÂú®ÂâçÈù¢<br>
                ‚Ä¢ ÊîØÊè¥Á¨¶Ëôü„ÄÅËã±Êñá„ÄÅ‰∏≠Ëã±Ê∑∑Âíå<br>
                ‚Ä¢ Ê†ºÂºèÔºöÂßìÂêç HCP (‰∏ÄË°å‰∏Ä‰∫∫)
            </div>
            <textarea id="input-text" placeholder="Ê†ºÂºèÁØÑ‰æãÔºö&#10;Jason Êûó 12&#10;ÁéãÂ§ßÊòé 18&#10;Vikki üëë 24"></textarea>
            
            <button class="btn btn-primary" onclick="processInput()">‰∏ã‰∏ÄÊ≠•ÔºöËß£ÊûêÂêçÂñÆ ‚ûî</button>
        </div>
        <div style="display:flex; gap:10px; justify-content:center;">
             <button class="btn btn-outline" style="width:auto; padding:8px 20px;" onclick="loadDemoData()">ËºâÂÖ•ÁØÑ‰æã (ÊòéÊòüÁâà)</button>
             <button class="btn btn-outline" style="width:auto; padding:8px 20px;" onclick="clearInput()">Ê∏ÖÁ©∫</button>
        </div>
    </div>

    <!-- STEP 2: Configure & Edit -->
    <div id="view-2" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>Á∑®ËºØËàáË®≠ÂÆö</h2>
                <span id="player-count-info" style="font-size:12px; font-weight:bold; color:var(--primary);"></span>
            </div>
            
            <!-- Quick Add -->
            <div style="display:flex; gap:8px; margin-bottom:15px; background:#F1F8E9; padding:8px; border-radius:8px;">
                <input id="new-name" class="name-edit" style="margin:0; background:white; padding:8px; border-radius:4px;" placeholder="Êñ∞Â¢ûÂßìÂêç...">
                <input id="new-hcp" type="number" class="hcp-input" style="width:50px; background:white;" placeholder="HCP">
                <button class="btn-primary" style="width:40px; margin:0;" onclick="manualAddPlayer()">+</button>
            </div>

            <div class="assign-list" id="player-list"></div>

            <div style="margin-top:20px; border-top:1px solid #EEE; padding-top:20px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:11px; font-weight:700; color:#888; text-transform:uppercase;">HCP Á≠ñÁï•</label>
                        <select id="hcp-logic" style="width:100%; padding:8px; border-radius:6px; border:1px solid #DDD; margin-top:4px;">
                            <option value="total_balanced" selected>‚öñÔ∏è Á∏ΩÂíåÂπ≥Âùá</option>
                            <option value="competitive">‚öîÔ∏è ÂØ¶ÂäõÁõ∏Ëøë</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:11px; font-weight:700; color:#888; text-transform:uppercase;">ÊÄßÂà•ÂàÜÈÖç</label>
                        <select id="gender-logic" style="width:100%; padding:8px; border-radius:6px; border:1px solid #DDD; margin-top:4px;">
                            <option value="balanced" selected>üë´ Âπ≥ÂùáÊ∑∑Á∑®</option>
                            <option value="random">üé≤ Èö®Ê©üÂàÜÈÖç</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="generateResult()">ÈñãÂßãÂàÜÁµÑ ‚õ≥</button>
            </div>
        </div>
    </div>

    <!-- STEP 3: Results -->
    <div id="view-3" class="hidden">
        <div style="margin-bottom:15px; display:flex; gap:10px;">
            <button class="btn btn-outline" style="margin:0; flex:1;" onclick="goToStep(1)">‚Ü∫ Èáç‰æÜ</button>
            <button id="btn-export" class="btn btn-green" style="margin:0; flex:2;" onclick="exportText()" disabled>üìã Ë§áË£ΩÂêçÂñÆ</button>
        </div>
        
        <div id="result-container"></div>
        <div style="height:30px;"></div>
    </div>

</div>

<!-- Toast -->
<div id="toast">Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø</div>

<script>
    let allPlayers = [];
    const MIN_PER_GROUP = 3;
    const MAX_PER_GROUP_STRICT = 4;
    const MANUAL_MAX_PER_GROUP = 5;

    let idCounter = 1;
    let finalGroups = [];

    // --- Demo Data (International Stars) ---
    function loadDemoData() {
        document.getElementById('input-text').value = 
`1. Tom ÊπØÂßÜÂÖãÈ≠ØÊñØ 12
2. Taylor Swift Ê≥∞ÂãíÁµ≤ 24
3. üëë The Rock 15
4. Scarlett ÈªëÂØ°Â©¶ üï∑Ô∏è 18
5. Tiger Woods 0
6. Stephen Curry üèÄ 8
7. Jennifer L. ÁèçÂ¶Æ‰Ωõ 28
8. Leonardo ÊùéÂ•ßÁ¥çÂ§ö 14`;
    }
    function clearInput() { document.getElementById('input-text').value = ''; }

    // --- Step 1: Logic ---
    function processInput() {
        const raw = document.getElementById('input-text').value.trim();
        if (!raw) { showToast("Ë´ãËº∏ÂÖ•Ë≥áÊñô"); return; }
        
        const lines = raw.split('\n');
        allPlayers = [];
        idCounter = 1;
        
        const femaleKeywords = ["Mrs", "Ms", "Miss", "Lady", "Â•≥", "Âßê", "Â¶π"];
        const femaleEmojiString = "ü©∑‚ù§Ô∏èüß°üíõüíúüíôü©µüíöüñ§ü©∂ü§çü§éüíïüíûüíìüíó‚ù£Ô∏èüíñüíòüíùüíüüßò‚Äç‚ôÄÔ∏è‚ú®‚≠êÔ∏èüåüüåπü¶Ñüëëüë†üëóüëôüôã‚Äç‚ôÄÔ∏èüôé‚Äç‚ôÄÔ∏èüôÜ‚Äç‚ôÄÔ∏èüíÅ‚Äç‚ôÄÔ∏èüë∏üèªüë©‚Äçü¶∞üë©üèªüëßüíãüòç";
        const femaleEmojis = [...femaleEmojiString]; 
        const leadingNumbers = /^[\d\.\s\)\-\]]+/;

        lines.forEach(line => {
            let cleanLine = line.trim();
            if (!cleanLine) return;
            // 1. Remove leading ranking numbers (e.g., "1. ")
            cleanLine = cleanLine.replace(leadingNumbers, '').trim(); 

            // 2. Extract HCP (numbers at the end)
            let hcp = 0;
            const hcpMatch = cleanLine.match(/(\d+(\.\d+)?)$/);
            if (hcpMatch) {
                hcp = parseFloat(hcpMatch[0]);
                cleanLine = cleanLine.substring(0, hcpMatch.index).trim();
            }

            // 3. Detect Gender (Check before cleaning name)
            let isFemale = false;
            // Check regex text keywords
            if (new RegExp(femaleKeywords.join('|'), 'i').test(cleanLine)) isFemale = true;
            // Check emojis
            if (femaleEmojis.some(emoji => cleanLine.includes(emoji))) isFemale = true;
            
            // Auto detect common female names (Simple heuristic for demo)
            if (/Taylor|Scarlett|Jennifer|Amy|Vikki|Lisa/i.test(cleanLine)) isFemale = true;

            // 4. Clean Name
            // Remove text keywords
            let namePart = cleanLine.replace(new RegExp(femaleKeywords.join('|'), 'gi'), '');
            // Remove specific gender emojis (but keep other emojis if needed)
            femaleEmojis.forEach(e => { namePart = namePart.split(e).join(''); });
            namePart = namePart.trim();

            // 5. Robust Reordering: Chinese First
            // Extract Chinese characters
            const chineseMatch = namePart.match(/[\u4e00-\u9fa5]+/g);
            const chineseStr = chineseMatch ? chineseMatch.join('') : "";
            
            // Remove Chinese to get the rest (English, numbers inside name, other symbols)
            let engStr = namePart.replace(/[\u4e00-\u9fa5]+/g, '').trim();

            // Reassemble
            let finalName = "";
            if (chineseStr && engStr) {
                finalName = `${chineseStr} ${engStr}`;
            } else {
                // If only one part exists
                finalName = chineseStr || engStr || "Player";
            }

            allPlayers.push({
                id: idCounter++,
                name: finalName,
                hcp: hcp, 
                gender: isFemale ? 'F' : 'M'
            });
        });

        updateCountInfo();
        renderPlayerList();
        goToStep(2);
    }

    // --- Step 2: Edit UI ---
    function updateCountInfo() {
        document.getElementById('player-count-info').innerText = `ÂÖ± ${allPlayers.length} ‰∫∫`;
    }

    function renderPlayerList() {
        const listDiv = document.getElementById('player-list');
        listDiv.innerHTML = "";

        allPlayers.forEach(p => {
            const div = document.createElement('div');
            div.className = `assign-item`;
            const genderClass = p.gender === 'F' ? 'female' : 'male';
            const genderIcon = p.gender === 'F' ? '‚ôÄ' : '‚ôÇ';

            div.innerHTML = `
                <div style="display:flex; align-items:center; flex:1;">
                    <div class="gender-toggle ${genderClass}" onclick="toggleGender(${p.id})">${genderIcon}</div>
                    <input type="text" class="name-edit" value="${p.name}" onchange="updatePlayerName(${p.id}, this.value)">
                </div>
                <div style="display:flex; align-items:center;">
                    <input type="number" class="hcp-input" value="${p.hcp}" onchange="updatePlayerHcp(${p.id}, this.value)">
                    <button class="btn-del" onclick="deletePlayer(${p.id})">√ó</button>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // Edit Actions
    function manualAddPlayer() {
        const nameInput = document.getElementById('new-name');
        const hcpInput = document.getElementById('new-hcp');
        const name = nameInput.value.trim();
        const hcp = parseFloat(hcpInput.value) || 0;
        if (name) {
            allPlayers.push({ id: idCounter++, name: name, hcp: hcp, gender: 'M' });
            nameInput.value = ''; hcpInput.value = '';
            updateCountInfo(); renderPlayerList();
        }
    }
    function deletePlayer(pid) {
        allPlayers = allPlayers.filter(p => p.id !== pid);
        updateCountInfo(); renderPlayerList();
    }
    function updatePlayerName(pid, val) { allPlayers.find(x => x.id === pid).name = val.trim(); }
    function updatePlayerHcp(pid, val) { allPlayers.find(x => x.id === pid).hcp = parseFloat(val) || 0; }
    function toggleGender(pid) { 
        const p = allPlayers.find(x => x.id === pid);
        if (p) { p.gender = p.gender === 'M' ? 'F' : 'M'; renderPlayerList(); }
    }

    // --- Step 3: Algorithm ---
    function generateResult() {
        if(allPlayers.length === 0) { showToast("ÂêçÂñÆÁÇ∫Á©∫"); return; }
        
        const genderLogic = document.getElementById('gender-logic').value; 
        const hcpLogic = document.getElementById('hcp-logic').value;
        
        let pool = JSON.parse(JSON.stringify(allPlayers)); // Deep copy
        const totalPeople = pool.length;
        const numGroups = Math.ceil(totalPeople / 4);
        let groups = Array.from({length: numGroups}, () => []);

        // Sort Helper
        const sortByHcpDesc = (list) => list.sort((a,b) => b.hcp - a.hcp);
        const sortByHcpAsc = (list) => list.sort((a,b) => a.hcp - b.hcp);

        if (hcpLogic === 'total_balanced') {
            // S-Shape (Snake) Distribution
            if(genderLogic === 'balanced') {
                // Separate genders
                let ladies = pool.filter(p=>p.gender==='F');
                let men = pool.filter(p=>p.gender==='M');
                sortByHcpDesc(ladies);
                sortByHcpDesc(men);

                // Distribute Ladies (Snake)
                ladies.forEach((p, i) => {
                    let pos = i % numGroups;
                    let gIdx = (Math.floor(i / numGroups) % 2 === 0) ? pos : (numGroups - 1 - pos);
                    groups[gIdx].push(p);
                });

                // Distribute Men 
                men.forEach(p => {
                    // Greedy fill: find group with < 4 people and lowest total HCP
                    let eligible = groups.map((g, i) => ({id: i, count: g.length, total: g.reduce((s,x)=>s+x.hcp,0)}))
                                         .filter(g => g.count < MAX_PER_GROUP_STRICT);
                    
                    if(eligible.length === 0) { 
                        groups[groups.length-1].push(p); // Overflow
                    } else {
                        eligible.sort((a,b) => a.total - b.total);
                        groups[eligible[0].id].push(p);
                    }
                });

            } else {
                // Mixed gender, just sort by HCP
                sortByHcpDesc(pool);
                pool.forEach((p, i) => {
                    let pos = i % numGroups;
                    let gIdx = (Math.floor(i / numGroups) % 2 === 0) ? pos : (numGroups - 1 - pos);
                    groups[gIdx].push(p);
                });
            }
        } else {
            // Competitive: Group by HCP slices (1-4, 5-8...)
            sortByHcpAsc(pool);
            pool.forEach((p, i) => {
                const gIdx = Math.floor(i / 4);
                if(groups[gIdx]) groups[gIdx].push(p);
                else groups[groups.length-1].push(p); // Overflow
            });
        }

        finalGroups = groups;
        renderResults();
        goToStep(3);
    }

    // --- Step 3: Render ---
    function renderResults() {
        const container = document.getElementById('result-container');
        const btnExport = document.getElementById('btn-export');
        container.innerHTML = "";
        let allValid = true; 

        finalGroups.forEach((g, idx) => {
            if(g.length === 0) return;
            
            const totalHcp = g.reduce((s,p)=>s+p.hcp,0);
            g.sort((a,b) => a.hcp - b.hcp); // Display order: Low to High

            let isValid = (g.length >= MIN_PER_GROUP && g.length <= MAX_PER_GROUP_STRICT);
            if (!isValid) allValid = false;
            
            let cardClass = isValid ? "scorecard" : "scorecard invalid";

            let rows = g.map(p => {
                const colorClass = p.gender === 'F' ? 'female' : 'male';
                
                // Move Options
                let moveOpts = "";
                for(let i=0; i<finalGroups.length; i++) {
                     let selected = (i === idx) ? "selected" : "";
                     moveOpts += `<option value="${i}" ${selected}>ÁßªËá≥ G${i+1}</option>`;
                }

                return `
                <tr>
                    <td>
                        <span class="p-name ${colorClass}">${p.name}</span>
                        <div style="display:flex;">
                            <select class="move-select" onchange="manualMove(${p.id}, ${idx}, this.value)">${moveOpts}</select>
                        </div>
                    </td>
                    <td style="text-align:right; font-weight:700; color:#546E7A;">${p.hcp}</td>
                </tr>`;
            }).join('');

            // Arrow Controls
            let upBtn = idx > 0 ? 
                `<button class="arrow-btn" onclick="swapGroup(${idx}, -1)">‚ñ≤</button>` : `<div style="width:28px;"></div>`;
            let downBtn = idx < finalGroups.length - 1 ? 
                `<button class="arrow-btn" onclick="swapGroup(${idx}, 1)">‚ñº</button>` : `<div style="width:28px;"></div>`;

            container.innerHTML += `
                <div class="${cardClass}">
                    <div class="scorecard-header">
                        <div class="group-info">
                            <span class="group-title">GROUP ${idx+1}</span>
                            <span class="group-stats">HCP ${totalHcp.toFixed(1)}</span>
                        </div>
                        <div class="order-actions">
                            ${upBtn} ${downBtn}
                        </div>
                    </div>
                    <table>${rows}</table>
                </div>`;
        });

        if (allValid && finalGroups.length > 0) {
            btnExport.disabled = false;
            btnExport.textContent = "üìã Ë§áË£ΩÊñáÂ≠óÂêçÂñÆ";
            btnExport.classList.add('btn-green');
        } else {
            btnExport.disabled = true;
            btnExport.textContent = "‚ö†Ô∏è Ë´ã‰øÆÊ≠£‰∫∫Êï∏ (3-4‰∫∫)";
            btnExport.classList.remove('btn-green');
        }
    }

    // --- Actions ---
    function manualMove(pid, fromIdx, toIdx) {
        fromIdx = parseInt(fromIdx); toIdx = parseInt(toIdx);
        if(fromIdx === toIdx) return;
        
        if(finalGroups[toIdx].length >= MANUAL_MAX_PER_GROUP) {
            showToast("Ë©≤ÁµÑ‰∫∫Êï∏Â∑≤ÈÅî‰∏äÈôê");
            renderResults(); // Reset dropdown
            return;
        }
        
        let pIndex = finalGroups[fromIdx].findIndex(p => p.id === pid);
        if(pIndex > -1) {
            let player = finalGroups[fromIdx].splice(pIndex, 1)[0];
            finalGroups[toIdx].push(player);
            renderResults();
        }
    }

    function swapGroup(index, direction) {
        let newIndex = index + direction;
        if(newIndex < 0 || newIndex >= finalGroups.length) return;
        [finalGroups[index], finalGroups[newIndex]] = [finalGroups[newIndex], finalGroups[index]];
        renderResults();
    }

    function exportText() {
        let text = "‚õ≥Ô∏è È´òÁàæÂ§´ÂàÜÁµÑÂêçÂñÆ\n==================\n";
        finalGroups.forEach((g, idx) => {
            if(g.length === 0) return;
            text += `\n[Á¨¨ ${idx+1} ÁµÑ] \n`;
            g.forEach(p => {
                text += `- ${p.name} (${p.hcp})\n`;
            });
            let total = g.reduce((s,p)=>s+p.hcp,0);
            text += `> Total HCP: ${total.toFixed(1)}\n`;
        });
        
        navigator.clipboard.writeText(text).then(() => {
            showToast("‚úÖ ÂêçÂñÆÂ∑≤Ë§áË£Ω");
        }).catch(() => {
            showToast("‚ùå Ë§áË£ΩÂ§±Êïó");
        });
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.className = "show";
        setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
    }

    function goToStep(n) {
        document.querySelectorAll('.step').forEach(e=>e.classList.remove('active'));
        document.getElementById(`tab-${n}`).classList.add('active');
        [1,2,3].forEach(i => document.getElementById(`view-${i}`).classList.add('hidden'));
        document.getElementById(`view-${n}`).classList.remove('hidden');
        window.scrollTo(0,0);
    }
</script>
</body>
</html>
